# ARIMA_PLUS Time Series Forecasting with Vertex AI & BigQuery ML

This project demonstrates how to build and deploy a **driver-based time series forecasting pipeline** using **Vertex AI Pipelines**, **BigQuery ML**, and the **ARIMA_PLUS** model for retail sales prediction.

> **Driver-based forecasting** refers to models that incorporate external influencing factors (drivers), such as promotions and holidays, alongside historical data to predict future outcomes.

**Reference notebook**:  
[Google Cloud BQML ARIMA_PLUS Tutorial](https://github.com/GoogleCloudPlatform/vertex-ai-samples/blob/main/notebooks/official/tabular_workflows/bqml_arima_plus.ipynb)

---

## üß† What is ARIMA_PLUS?

**ARIMA_PLUS** is an enhanced version of the traditional ARIMA model, provided by **BigQuery ML**, with support for:

- **Time series decomposition** (trend, seasonality, holiday effects)
- **External regressors (drivers)** such as `advertisement` and `holiday`
- **Probabilistic forecasts** with confidence intervals
- **Automatic backtesting** for evaluation

üìò [Official ARIMA_PLUS documentation](https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create-time-series)

---

## üì¶ Dataset Overview

The dataset contains **synthetic retail sales time series** generated by combining multiple stores and products, with covariates simulating real-world effects.

| Column          | Description                                |
|-----------------|--------------------------------------------|
| `store`         | Store identifier (categorical)             |
| `product`       | Product identifier (categorical)           |
| `date`          | Daily timestamp                            |
| `sales`         | Target variable (numeric)                  |
| `advertisement` | Binary indicator for ad placement          |
| `holiday`       | Binary indicator for holidays              |
| `split`         | One of `TRAIN`, `VALIDATE`, `TEST`, `PREDICT` |

üìå **Split logic**:
- `TRAIN`: before 2019-09-01
- `VALIDATE`: 2019-09-01 to 09-30
- `TEST`: 2019-10-01 to 10-31
- `PREDICT`: 2019-11-01 onward

---

### üîê Permissions
Ensure the service account used has:
- roles/bigquery.admin
- roles/storage.objectAdmin
- roles/aiplatform.user

---

## üìä Pipeline Stages

### 1. Setup

Creates two BigQuery tables:
- `forecasting_demo_arima.train`: training + validation + test data
- `forecasting_demo_arima.pred`: test data + future (`PREDICT`) dates with `sales = NULL`

---

### 2. Training the ARIMA_PLUS Model

- Executed via **Vertex AI Pipelines** with `automl-tabular-bqml-arima-train`
- Model trained on grouped time series (`store + product`)
- Incorporates external drivers: `advertisement`, `holiday`
- Output model stored as: forecasting_demo_arima.model_<model_id>


![Runtime Graph](training.png)  
> Training monitored via Vertex AI UI

---

### 3. Evaluation

- Backtesting is used to simulate future forecasts using known historical data (`TEST` split)
- Results are saved in `forecasting_demo_arima.evaluated_examples`
- Manual evaluation using:

```sql
SELECT sales, predicted_sales.value 
FROM forecasting_demo_arima.evaluated_examples

The evaluate.py script computes:
- MAE (Mean Absolute Error)
- RMSE (Root Mean Squared Error)
- MAPE (Mean Absolute Percentage Error)
```
---

### 4. Batch Prediction

- Uses the trained model to forecast future (`PREDICT` split) dates
- Outputs stored in BigQuery table: `forecasting_demo_arima.predictions_<job_id>`

Includes:
- predicted_sales
- Components: trend, seasonal, holiday_effect, etc.

---

### 5. Visualization

To visualize results in Looker Studio:
1. Create an actuals table from non-TRAIN data:
```sql
CREATE OR REPLACE TABLE forecasting_demo_arima.actuals AS
SELECT * FROM forecasting_demo_arima.train WHERE split != 'TRAIN'
```
2. Run `visualize.py` to generate a Looker Studio dashboard link
3. The dashboard shows: historical sales (BLUE), forecasted sales (RED)

![Output Visualization](looker.png)  
The model accurately forecasts a spike in sales in late November, consistent with prior patterns observed in 2017 and 2018. This aligns with consumer behavior around Black Friday and Christmas shopping, validating ARIMA_PLUS's ability to detect seasonal trends.

---

### üõ†Ô∏è Running the Pipeline

1. python setup.py
2. python train.py
3. python evaluate.py
4. python predict.py
5. python visualize.py
